CC=g++
OBJ = src/classifier.o src/config.o src/hog_features.o src/hypothesis.o src/image2hits.o src/model.o src/object_hypothesis.o src/poselet.o src/poselet_api.o src/poselet_cluster.o src/poselet_detector.o src/poselet_hit.o src/mat_imresize.o include/gil_draw.o main.o

#MATLAB = /Applications/MATLAB_R2012a.app
BOOST = ../../boost_1_50_0

ifdef MATLAB
  MEXOBJ = poselets_mex/main.o
  MEXINC = -I$(MATLAB)/extern/include
  MEXEXT = $(shell $(MATLAB)/bin/mexext)
  MEXLDFLAGS = -Llib -L/usr/lib/gcc/i686-apple-darwin10/4.2.1/x86_64 -lgomp
  MEXOUT = poselets_mex.$(MEXEXT)
  MEXSRC=$(MEXOBJ:.o=.cpp)
endif

#CFLAGS  = -O3 -Wall -fPIC -msse4.2 #-fopenmp
CFLAGS  = -g -Wall -fPIC -msse4.2 #-fopenmp
INCLUDES = -Isrc -Iinclude -Ithird_party/rapidxml-1.13 -I$(BOOST) -Ithird_party -Iutil
TESTLDFLAGS = -Llib -ljpeg -lpng
OUT = lib/libposelet.a
DEPS =

SRC=$(OBJ:.o=.cpp)

ifdef MATLAB
$(MEXOUT) : $(MEXOUT) $(MEXOBJ)
	$(MATLAB)/bin/mex $(INCLUDES) $(MEXINC) $(MEXLDFLAGS) -lposelet $(MEXSRC) -o $(MEXOUT)

$(MEXOBJ) : $(MEXSRC)
	$(CC) $(CFLAGS) $(INCLUDES) $(MEXINC) -c -o $@ $<
endif

$(OUT): $(OBJ)
	ar rcs $(OUT) $(OBJ)

%.o: %.cpp $(DEPS)
	$(CC) $(CFLAGS) $(INCLUDES) -c -o $@ $<

test : $(OUT)
	$(CC) $(CFLAGS) $(INCLUDES) $(TESTLDFLAGS) poselets_test/main.cpp include/gil_imdebug.cpp -lposelet -ljpeg -lpng -o poselets_test/poselets_test

clean:
	rm -f $(OBJ) $(OUT) $(MEXOUT)
